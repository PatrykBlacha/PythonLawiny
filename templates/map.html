{% extends "base.html" %}

{% block title %}Mapa Turystyczna - Mapa{% endblock %}

{% block content %}
<head>
     <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14=" crossorigin="" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js" integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script>
</head>
<div class="search-container">
    <input type="text" id="search-box" placeholder="Wyszukaj szczyt...">
    <button onclick="searchPeak()" id="search-button">Szukaj</button>
</div>
<div id="map"></div>
<script>
    var map = L.map('map').setView([49.231556, 19.981972], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var markers = [];

    // Domyślny marker (Kasprowy)
    //var defaultMarker = L.marker([49.231556, 19.981972]).addTo(map);
    //defaultMarker.bindPopup(`<b>Kasprowy Wierch</b><br>Jedno z najpopularniejszych miejsc w Tatrach.<button onclick="removeMarker(0)">Usuń</button>`).openPopup();
    //markers.push(defaultMarker); // indeks 0


    // === FUNKCJA WCZYTAJĄCA MARKERY ===
    function loadMarkers() {
        fetch('/api/markers', {
            method: 'GET',
            credentials: 'include'  // ważne dla uwierzytelnienia
        })
        .then(response => {
            if (!response.ok) throw new Error("Błąd wczytywania markerów");
            return response.json();
        })
        .then(dataArray => {
            dataArray.forEach(markerData => {
                const marker = L.marker([markerData.latitude, markerData.longitude]).addTo(map);
                marker.bindPopup(`<b>${markerData.name}</b><br>ID: ${markerData.id}<br><button onclick="removeMarkerById(${markerData.id}, ${markers.length})">Usuń</button>`);
                markers.push(marker);
            });
        })
        .catch(error => {
            console.error("Nie udało się pobrać markerów:", error);
            alert("Nie można wczytać Twoich markerów.");
        });
    }

    // === URUCHOM WCZYTYWANIE MARKERÓW PRZY STARTOWANIU ===
    document.addEventListener("DOMContentLoaded", () => {
        loadMarkers();  // Załaduj markery jak tylko DOM jest gotowy
    });

    function searchPeak() {
        var peakName = document.getElementById('search-box').value;
        if (!peakName) {
            alert("Proszę wpisać nazwę szczytu.");
            return;
        }

        fetch(`/search_peak?q=${encodeURIComponent(peakName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                map.setView([data.lat, data.lon], 13);
                var marker = L.marker([data.lat, data.lon]).addTo(map);
                marker.bindPopup(`<b>${data.name}</b><br><button onclick="removeMarker(${markers.length})">Usuń</button>`).openPopup();
                markers.push(marker);
            })
            .catch(error => {
                console.error('Błąd:', error);
                alert("Wystąpił błąd podczas wyszukiwania.");
            });
    }

    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        const newMarker = L.marker([lat, lng]).addTo(map);
        newMarker.bindPopup("<b>Nowy marker</b><br><button disabled>Trwa dodawanie...</button>").openPopup();

        // Wyślij dane do API
        fetch('/api/markers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                name: "Szczyt",
                latitude: lat,
                longitude: lng,
                description: "Piękne miejsce"
            })
        })
        .then(response => {
            if (!response.ok) throw new Error("Nie udało się dodać markera");
            return response.json();
        })
        .then(data => {
            // Ustaw nową zawartość popupu z przechowywanym ID z bazy
            newMarker.setPopupContent(`<b>Szczyt</b><br>ID: ${data.id}<br><button onclick="removeMarkerById(${data.id}, ${markers.length})">Usuń</button>`);
            markers.push(newMarker);
        })
        .catch(error => {
            console.error('Błąd:', error);
            alert('Wystąpił błąd podczas dodawania markera.');
            map.removeLayer(newMarker);
        });
    });

    // Usuwanie po ID markera z bazy
    function removeMarkerById(markerId, index) {
        fetch(`/api/markers/${markerId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) throw new Error("Nie udało się usunąć markera");
            return response.json();
        })
        .then(() => {
            alert("Marker został usunięty.");
            map.removeLayer(markers[index]);
            markers.splice(index, 1);
        })
        .catch(error => {
            console.error('Błąd:', error);
            alert('Wystąpił błąd podczas usuwania markera.');
        });
    }

    // Stare usuwanie po indeksie (opcjonalne, np. dla domyślnego markera)
    function removeMarker(index) {
        if (confirm("Czy na pewno chcesz usunąć ten marker?")) {
            map.removeLayer(markers[index]);
            markers.splice(index, 1);
        }
    }
</script>
{% endblock %}
